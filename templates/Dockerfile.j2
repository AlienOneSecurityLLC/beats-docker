# This Dockerfile was generated from templates/Dockerfile.j2
{% set beat_home = '/usr/share/%s' % beat -%}
{% set binary_file = '%s/%s' % (beat_home, beat) -%}
{% set config_file = '/etc/%s/%s.yml' % (beat, beat) -%}
{% set script_file = '/usr/local/bin/%s-docker' % beat -%}

FROM ubuntu:16.04
MAINTAINER Elastic Docker Team <docker@elastic.co>

RUN apt-get update && apt-get install -y curl && apt-get clean

RUN curl -Lso - {{ url }} | \
      tar zxf - -C /tmp && \
    mv /tmp/{{ beat }}-{{ version }}-linux-x86_64 {{ beat_home }}

RUN curl -Lso {{ beat_home }}/beats-dashboards-{{ version }}.zip \
      https://artifacts.elastic.co/downloads/beats/beats-dashboards/beats-dashboards-{{ version }}.zip

ENV PATH={{ beat_home }}:$PATH

COPY config/{{ beat }}.yml {{ config_file }}
COPY config/{{ beat }}-docker.sh {{ script_file }}
RUN chmod 0755 {{ script_file }}

# Provide a non-root user.
RUN chown --recursive 1000:1000 {{ beat_home }} && \
    addgroup --gid 1000 {{ beat }} && \
    adduser --disabled-password \
            --gecos={{ beat }} \
            --uid=1000 \
            --gid=1000 \
            --home {{ beat_home }} \
            {{ beat }}

RUN mkdir -p /etc/{{ beat }} && \
    chown root:{{ beat }} /etc/{{ beat }} && \
    chmod 0750 /etc/{{ beat }} && \
    for dir in /var/lib/{{ beat }} /var/log/{{ beat }}; do \
      mkdir -p $dir && \
      chown {{ beat }}:{{ beat }} $dir && \
      chmod 0770 $dir; \
    done

RUN ln -s {{ beat_home }}/{{ beat }}.template*.json /etc/{{ beat }}/

# Protect critical files from manipulation by the non-root user.
RUN chown root:{{ beat }} {{ binary_file }} && \
    chmod 0750 {{ binary_file }} && \
    chown root:{{ beat }} {{ config_file }} && \
    chmod 0640 {{ config_file }}

{%- if beat == 'packetbeat' %}
USER root
{%- else %}
USER {{ beat }}
{% endif %}

WORKDIR {{ beat_home }}

CMD ["{{ script_file }}"]
