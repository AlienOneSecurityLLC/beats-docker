---
# This file was generated from templates/docker-compose.yml.j2
version: '2'
services:
{%- for beat in beats.split() %}
  {{ beat }}:
    image: {{ registry }}/beats/{{ beat }}:{{ version }}
    container_name: {{ beat }}

    {%- if beat == 'filebeat' %}
    volumes:
      - /var/log:/mnt/log:ro
    {%- endif %}

    {%- if beat == 'packetbeat' %}
    cap_add:
      - NET_RAW
      - NET_ADMIN
    command: packetbeat -v -e -E output.elasticsearch.hosts='["localhost:9200"]'
    network_mode: host
    {%- else %}
    networks:
       - beats
    {%- endif %}

    {%- if beat == 'metricbeat' %}
    # REF: https://www.elastic.co/guide/en/beats/metricbeat/current/running-in-container.html
    volumes:
      - /proc:/hostfs/proc:ro
      - /sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro
      - /:/hostfs:ro
    command: metricbeat -e -system.hostfs=/hostfs
    {%- endif %}
{% endfor %}
  elasticsearch:
    image: {{ registry }}/elasticsearch/elasticsearch:{{ version }}
    container_name: elasticsearch
    environment:
      - "http.host=0.0.0.0"
      - "transport.host=127.0.0.1"
    ports:
      - '9200:9200'
    networks:
       - beats

  kibana:
    image: {{ registry }}/kibana/kibana:{{ version }}
    container_name: kibana
    ports:
      - '5601:5601'
    networks:
       - beats

networks:
  beats:
